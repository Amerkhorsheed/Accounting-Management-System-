# Implementation Plan

- [x] 1. Fix Authentication Endpoints
  - [x] 1.1 Update accounts/urls.py to fix JWT token endpoint paths
    - Change login endpoint to match frontend expectations
    - Ensure refresh endpoint is properly configured
    - _Requirements: 1.1, 1.4_
  - [x] 1.2 Fix UserViewSet.me() action to return proper user data
    - Ensure the endpoint returns all required user fields
    - _Requirements: 1.3_
  - [ ]* 1.3 Write property test for authentication
    - **Property 1: Authentication Token Validity**
    - **Validates: Requirements 1.1, 1.2**

- [x] 2. Fix Inventory API Endpoints
  - [x] 2.1 Fix ProductViewSet.by_barcode() to accept POST requests
    - Update the action decorator to allow POST method
    - Fix the request data handling
    - _Requirements: 2.4_
  - [x] 2.2 Fix ProductCreateSerializer validation
    - Add proper validation for required fields
    - Ensure unit field is properly handled
    - _Requirements: 2.1_
  - [x] 2.3 Implement proper soft delete in ProductViewSet
    - Override destroy() method to use soft_delete()
    - Ensure deleted products don't appear in list queries
    - _Requirements: 2.3_
  - [ ]* 2.4 Write property tests for inventory operations
    - **Property 3: Product Auto-Generation**
    - **Property 4: Partial Update Isolation**
    - **Property 5: Soft Delete Preservation**
    - **Property 6: Barcode Search Correctness**
    - **Validates: Requirements 2.1, 2.2, 2.3, 2.4**

- [x] 3. Fix Sales API Endpoints
  - [x] 3.1 Fix InvoiceCreateSerializer nested item handling
    - Properly handle nested items creation
    - Ensure transaction atomicity
    - _Requirements: 3.2_
  - [x] 3.2 Fix PaymentViewSet to use SalesService
    - Route payment creation through service layer
    - Ensure proper balance updates
    - _Requirements: 3.4_
  - [x] 3.3 Fix CustomerViewSet for proper CRUD operations
    - Ensure auto-generated code on creation
    - Implement proper soft delete
    - _Requirements: 3.1_
  - [ ]* 3.4 Write property tests for sales operations
    - **Property 8: Customer Code Auto-Generation**
    - **Property 9: Invoice Transaction Atomicity**
    - **Property 10: Invoice Confirmation Stock Deduction**
    - **Property 11: Payment Balance Update**
    - **Validates: Requirements 3.1, 3.2, 3.3, 3.4**

- [ ] 4. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 5. Fix Purchases API Endpoints
  - [x] 5.1 Fix PurchaseOrderCreateSerializer nested item handling
    - Properly handle nested items creation
    - Ensure transaction atomicity
    - _Requirements: 4.2_
  - [x] 5.2 Fix SupplierViewSet for proper CRUD operations
    - Ensure auto-generated code on creation
    - Implement proper soft delete
    - _Requirements: 4.1_
  - [x] 5.3 Fix PurchaseService.receive_goods() to update all records
    - Ensure GRN is created properly
    - Update stock levels correctly
    - Update PO status appropriately
    - _Requirements: 4.4_
  - [ ]* 5.4 Write property tests for purchase operations
    - **Property 13: Supplier Code Auto-Generation**
    - **Property 14: Purchase Order Transaction Atomicity**
    - **Property 15: Goods Receiving Stock Addition**
    - **Validates: Requirements 4.1, 4.2, 4.4**

- [x] 6. Fix Expenses API Endpoints
  - [x] 6.1 Fix ExpenseViewSet.summary() import issue
    - Move models import to top of file
    - Fix aggregation query
    - _Requirements: 5.4_
  - [x] 6.2 Ensure Expense total calculation is correct
    - Verify total_amount = amount + tax_amount in save()
    - _Requirements: 5.2_
  - [ ]* 6.3 Write property test for expense operations
    - **Property 16: Expense Total Calculation**
    - **Validates: Requirements 5.2**

- [x] 7. Fix Core Settings API Endpoints
  - [x] 7.1 Fix Currency conversion validation
    - Add validation for zero exchange rates
    - Handle edge cases in conversion
    - _Requirements: 7.2_
  - [x] 7.2 Fix SystemSettings bulk update validation
    - Add input validation for settings data
    - _Requirements: 7.4_
  - [ ]* 7.3 Write property test for currency conversion
    - **Property 18: Currency Conversion Formula**
    - **Validates: Requirements 7.2**

- [x] 8. Implement Custom Exception Handler
  - [x] 8.1 Create custom exception handler function
    - Handle all custom business exceptions
    - Return proper HTTP status codes and error formats
    - _Requirements: 8.1, 8.2, 8.3, 8.4_
  - [x] 8.2 Register exception handler in REST Framework settings
    - Update base.py settings
    - _Requirements: 8.1_
  - [ ]* 8.3 Write property tests for error handling
    - **Property 19: Validation Error Response Format**
    - **Validates: Requirements 8.1**

- [x] 9. Fix Stock Management Operations
  - [x] 9.1 Verify InventoryService.adjust_stock() creates proper movement records
    - Ensure balance_before and balance_after are correct
    - _Requirements: 9.1_
  - [x] 9.2 Verify InventoryService.deduct_stock() validates quantity
    - Ensure InsufficientStockException is raised when needed
    - _Requirements: 9.2_
  - [x] 9.3 Verify InventoryService.get_low_stock_products() filtering
    - Ensure products below minimum_stock are returned
    - _Requirements: 9.4_
  - [ ]* 9.4 Write property tests for stock operations
    - **Property 20: Stock Movement Balance Tracking**
    - **Property 21: Insufficient Stock Prevention**
    - **Property 22: Low Stock Detection**
    - **Validates: Requirements 9.1, 9.2, 9.4**

- [ ] 10. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 11. Add Missing ViewSet Methods
  - [x] 11.1 Add destroy() override to all ViewSets for soft delete
    - ProductViewSet, CustomerViewSet, SupplierViewSet, etc.
    - _Requirements: 2.3_
  - [x] 11.2 Add perform_destroy() method to handle soft delete
    - Use model's soft_delete() method
    - _Requirements: 2.3_

- [x] 12. Fix Frontend API Compatibility Issues
  - [x] 12.1 Ensure all endpoints return consistent response format
    - List endpoints return paginated results
    - Detail endpoints return single object
    - _Requirements: 2.1, 3.1, 4.1_
  - [x] 12.2 Add missing fields to serializers
    - Ensure all fields expected by frontend are included
    - _Requirements: 2.1, 3.1, 4.1_

- [ ] 13. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
